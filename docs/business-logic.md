# Бизнес-логика приложения SmartResponse

## Оглавление
1. [Что такое SmartResponse](#что-такое-smartresponse)
2. [Роли пользователей](#роли-пользователей)
3. [Как работает система](#как-работает-система)
4. [Ограничения и квоты](#ограничения-и-квоты)
5. [Процесс работы с формами](#процесс-работы-с-формами)
6. [Процесс получения лидов](#процесс-получения-лидов)
7. [База знаний](#база-знаний)
8. [Генерация контента](#генерация-контента)
9. [Email уведомления](#email-уведомления)
10. [Взаимодействие компонентов](#взаимодействие-компонентов)
11. [Особые случаи и правила](#особые-случаи-и-правила)

---

## Что такое SmartResponse

SmartResponse — это платформа для создания интерактивных форм с AI-генерацией контента. Пользователи создают формы, которые собирают данные от респондентов и автоматически генерируют персонализированные ответы с помощью искусственного интеллекта.

### Основные возможности:
- **Создание форм** с настраиваемыми полями
- **AI-генерация** текстовых ответов или изображений на основе данных респондента
- **Сбор лидов** с автоматическим сохранением всех данных
- **База знаний** для улучшения качества генерации
- **Email уведомления** владельцу формы и респонденту

---

## Роли пользователей

### Администратор (Superadmin)
**Email**: `hello@vasilkov.digital`

**Возможности**:
- Неограниченное количество форм
- Неограниченное количество лидов
- Неограниченное хранилище для файлов
- Неограниченное тестирование форм
- Доступ ко всем формам и лидам всех пользователей
- Управление квотами других пользователей
- Настройка системных параметров AI
- Просмотр статистики всех пользователей
- Экспорт данных пользователей

### Обычный пользователь (User)

**Возможности**:
- Создание и настройка собственных форм
- Просмотр и управление своими лидами
- Загрузка файлов в базу знаний
- Тестирование своих форм

**Ограничения**: см. раздел [Ограничения и квоты](#ограничения-и-квоты)

---

## Как работает система

### Общий процесс работы

1. **Пользователь создает форму**
   - Настраивает поля для сбора данных
   - Настраивает промпт для AI
   - Выбирает формат результата (текст, изображение или оба)
   - Загружает файлы в базу знаний (опционально)
   - Активирует форму

2. **Респондент заполняет форму**
   - Вводит данные в поля формы
   - Может указать URL для анализа
   - Может загрузить изображение
   - Вводит email для получения результата

3. **Система генерирует ответ**
   - Анализирует данные респондента
   - Использует базу знаний (если настроена)
   - Генерирует персонализированный ответ через AI
   - Сохраняет результат как лид

4. **Отправка результатов**
   - Респондент видит результат на странице
   - Респонденту отправляется email (если включено)
   - Владельцу формы отправляется уведомление (если включено)

---

## Ограничения и квоты

### Для обычных пользователей

#### Количество форм
- **По умолчанию**: 2 формы
- **Можно увеличить**: Администратор может изменить лимит
- **Сообщение при превышении**: "Достигнут лимит форм (X/Y). Для увеличения лимита свяжитесь с администратором."

#### Количество лидов
- **По умолчанию**: 20 лидов суммарно по всем формам
- **Можно увеличить**: Администратор может изменить лимит
- **Сообщение при превышении**: "Достигнут лимит лидов для аккаунта (X/Y). Владельцу необходимо связаться с администратором."

#### Право на публикацию форм
- **По умолчанию**: Разрешено
- **Может быть отключено**: Администратором
- **Сообщение при отключении**: "Публикация форм отключена для вашего аккаунта. Свяжитесь с администратором."

#### Хранилище файлов
- **По умолчанию**: 50 МБ
- **Можно увеличить**: Администратор может изменить лимит
- **Сообщение при превышении**: "Превышен лимит хранилища (X/Y МБ). Удалите ненужные файлы или обратитесь к администратору."

#### Тестирование форм
- **По умолчанию**: 50 тестирований в день
- **Сброс**: Автоматически каждый день в полночь
- **Можно увеличить**: Администратор может изменить лимит
- **Сообщение при превышении**: "Достигнут дневной лимит тестирования (X/Y). Лимит обновится завтра."

### Для респондентов (неавторизованных пользователей)

#### Лимит использований формы
- **Лимит**: 5 раз на одну форму одним email
- **Цель**: Предотвращение злоупотреблений
- **Сообщение**: "Вы достигли лимита использований формы (5 раз). Зарегистрируйтесь для создания своих форм с расширенным количеством генераций."

### Для администратора

- **Все лимиты**: Неограниченно
- **Доступ**: Ко всем данным системы

---

## Процесс работы с формами

### Создание формы

**Шаги**:
1. Пользователь нажимает "Создать форму"
2. Система проверяет:
   - Не превышен ли лимит форм
   - Разрешена ли публикация форм
3. Форма создается с настройками по умолчанию
4. Форма создается в неактивном состоянии (нельзя использовать)

**Настройки по умолчанию**:
- Лимит лидов: 20
- Уведомления владельцу: Включены
- Email респонденту: Включен
- Тема: Светлая
- Язык: Русский
- Формат результата: Текст

### Настройка формы

**Что можно настроить**:

#### Контентные элементы
- Название формы
- Подзаголовок страницы
- Дисклеймер (например, "Бесплатно • Занимает 30 секунд")
- Подзаголовок для шага ввода email

#### Поля формы
Пользователь может добавить различные типы полей:
- **Текстовое поле** - для ввода текста
- **URL поле** - для ввода ссылки (система автоматически загружает контент)
- **Выпадающий список** - выбор одного варианта
- **Множественный выбор** - выбор нескольких вариантов
- **Чекбокс** - да/нет
- **Загрузка изображения** - для загрузки картинки
- **Заголовки** - для структурирования формы
- **Дисклеймер** - для отображения информации

Каждое поле можно сделать обязательным или необязательным.

#### Настройки AI
- **Промпт для AI** - инструкции для генерации контента
- **Формат результата**:
  - Только текст
  - Только изображение
  - Изображение + текст

#### База знаний
- Включение/выключение базы знаний
- URL для загрузки контента
- Загрузка файлов (PDF, DOCX, изображения и др.)

#### Уведомления
- Уведомления владельцу при новом лиде
- Отправка email респонденту с результатом

#### Внешний вид
- Тема формы (светлая/темная)
- Язык системных сообщений (русский/английский)

### Активация формы

**Требования для активации**:
- Форма должна содержать хотя бы одно поле
- Не должно быть превышено ограничение на количество форм
- Должно быть разрешено публиковать формы

**После активации**:
- Форма становится доступной по публичной ссылке
- Респонденты могут заполнять форму
- Лиды начинают собираться

### Деактивация формы

- Форма перестает быть доступной по публичной ссылке
- Существующие лиды сохраняются
- Форму можно снова активировать в любой момент

### Удаление формы

**Что удаляется**:
- Сама форма
- Все поля формы
- Все лиды формы
- Все файлы базы знаний формы

**Важно**: Удаление необратимо!

---

## Процесс получения лидов

### Что происходит, когда респондент заполняет форму

#### Шаг 1: Заполнение данных
Респондент:
- Заполняет поля формы
- Может указать URL для анализа
- Может загрузить изображение
- Вводит email

#### Шаг 2: Генерация результата
Система:
1. Проверяет лимиты (для респондента и владельца формы)
2. Собирает все данные респондента
3. Загружает контент из URL (если указан)
4. Использует базу знаний (если настроена)
5. Генерирует ответ через AI
6. Сохраняет результат

#### Шаг 3: Сохранение лида
Система создает запись лида, которая содержит:
- Email респондента
- Все данные из полей формы
- URL (если был указан)
- Сгенерированный текст
- Сгенерированное изображение (если формат изображения)
- Дата и время создания
- Статус обработки (новый/в работе/выполнено)
- Заметки владельца формы

#### Шаг 4: Отправка результатов
- Респондент видит результат на странице
- Респонденту отправляется email (если включено)
- Владельцу формы отправляется уведомление (если включено)

### Проверки перед созданием лида

#### Для обычного респондента:
1. **Лимит использований формы**: Не более 5 раз одним email
2. **Лимит лидов владельца**: Не превышен ли общий лимит лидов владельца формы

#### Для владельца формы (при тестировании):
1. **Дневной лимит тестирований**: Не превышен ли лимит (50 раз в день)
2. **Лимит лидов**: Не проверяется (владелец может тестировать неограниченно)

#### Для тестового email (`hello@vasilkov.digital`):
- Все проверки пропускаются
- Можно использовать форму неограниченно

### Управление лидами

**Что может делать владелец формы**:

#### Просмотр лидов
- Видеть все лиды своих форм
- Фильтровать по формам
- Видеть статус каждого лида

#### Обновление статуса
- **Новый** - лид только что получен
- **В работе** - лид обрабатывается
- **Выполнено** - лид обработан

#### Добавление заметок
- Может добавлять заметки к каждому лиду
- Заметки видны только владельцу формы

#### Удаление лидов
- Может удалять лиды
- При удалении счетчик лидов уменьшается

---

## База знаний

### Что это такое

База знаний — это набор файлов и ссылок, которые используются AI для улучшения качества генерации контента. Система анализирует содержимое базы знаний и использует его при создании ответов.

### Что можно загрузить

#### Документы:
- PDF файлы
- Документы Word (DOCX, DOC)
- Текстовые файлы (TXT)
- Markdown файлы
- CSV файлы
- JSON файлы

#### Изображения:
- PNG
- JPEG/JPG
- WebP
- GIF
- HEIC (автоматически конвертируется в JPEG)

### Ограничения

#### Количество файлов
- **Максимум**: 10 файлов на форму
- **Сообщение при превышении**: "Достигнут лимит файлов (10)"

#### Размер файла
- **Для обычных пользователей**: 1 МБ на файл
- **Для администратора**: 10 МБ на файл
- **Сообщение при превышении**: "Файл слишком большой. Максимальный размер: X МБ"

#### Общий размер хранилища
- **Для обычных пользователей**: 50 МБ суммарно
- **Для администратора**: Неограниченно
- **Сообщение при превышении**: "Превышен лимит хранилища (X/Y МБ). Удалите ненужные файлы или обратитесь к администратору."

### Как используется база знаний

1. **Текстовые файлы**: Система извлекает текст и использует его в контексте для AI
2. **Изображения**: Система передает изображения в AI для анализа (multimodal режим)
3. **URL**: Система загружает контент со страницы и использует его

Вся информация из базы знаний объединяется и передается AI вместе с данными респондента для создания более точного и релевантного ответа.

---

## Генерация контента

### Как работает генерация

#### Процесс генерации текста

1. **Сбор данных**:
   - Данные из полей формы
   - Контент из URL (если указан)
   - Контент из базы знаний
   - Изображения из базы знаний и полей формы

2. **Формирование промпта**:
   - Используется глобальный промпт (настраивается администратором)
   - Добавляется индивидуальный промпт формы (если настроен)
   - Комбинируются в единую инструкцию для AI

3. **Генерация**:
   - AI анализирует все данные
   - Создает персонализированный ответ
   - Форматирует результат (Markdown)

4. **Возврат результата**:
   - Текст отображается респонденту
   - Сохраняется в лиде

#### Процесс генерации изображения

1. **Сбор данных** (как для текста)

2. **Создание промпта для изображения**:
   - AI анализирует весь контекст
   - Создает короткий промпт для генерации изображения (максимум 3500 символов)
   - Промпт описывает визуальные элементы, которые нужно создать

3. **Генерация изображения**:
   - Если респондент загрузил изображение: редактируется существующее изображение
   - Если нет: создается новое изображение
   - Размер: 1024x1024 пикселей

4. **Сохранение**:
   - Изображение сохраняется в системе
   - URL изображения возвращается респонденту
   - Сохраняется в лиде

#### Формат "Изображение + Текст"

1. Генерируется изображение (как описано выше)
2. Дополнительно генерируется текстовое описание
3. Оба результата показываются респонденту

### Настройки генерации

#### Глобальные настройки (только для администратора)
- **Промпт для текста**: Общая инструкция для всех форм
- **Промпт для изображений**: Общая инструкция для генерации изображений
- **Модель для текста**: Какая AI-модель используется (GPT-4, GPT-3.5 и др.)
- **Модель для изображений**: Какая модель используется (если поддерживается)

#### Индивидуальные настройки формы
- **Промпт формы**: Дополнительные инструкции для конкретной формы
- **Формат результата**: Текст, изображение или оба

### Что влияет на качество генерации

1. **Качество промпта**: Чем точнее описаны требования, тем лучше результат
2. **База знаний**: Чем больше релевантной информации, тем точнее ответ
3. **Данные респондента**: Чем больше данных, тем более персонализированный ответ
4. **Модель AI**: Более продвинутые модели дают лучшие результаты

---

## Email уведомления

### Уведомление владельцу формы

#### Когда отправляется
- Новый респондент заполнил форму
- Форма настроена на отправку уведомлений
- Это не тестовый email
- Это не владелец формы (тестирование)

#### Что в письме
- Название формы
- Email респондента
- URL, который указал респондент (если был)
- Сайт, с которого пришел респондент (если известен)
- Сгенерированное изображение (если формат изображения)
- Сгенерированный текст
- Ссылка на личный кабинет для просмотра лида

#### Настройка
- Можно включить/выключить для каждой формы отдельно
- По умолчанию включено

### Email респонденту

#### Когда отправляется
- Респондент успешно заполнил форму
- Форма настроена на отправку email респонденту
- Результат успешно сгенерирован

#### Что в письме
- Сгенерированный результат (текст или изображение)
- Зависит от формата результата формы

#### Настройка
- Можно включить/выключить для каждой формы отдельно
- По умолчанию включено

---

## Взаимодействие компонентов

### Пользователь и его формы

**Связь**: Один пользователь может создать несколько форм

**Правила**:
- Пользователь видит только свои формы
- При удалении пользователя удаляются все его формы
- Лимит лидов считается суммарно по всем формам пользователя

### Форма и её поля

**Связь**: Одна форма содержит несколько полей

**Правила**:
- Поля определяют, какие данные собираются от респондента
- Порядок полей можно изменять
- При удалении формы удаляются все её поля
- Форма не может быть активирована без полей

### Форма и её лиды

**Связь**: Одна форма собирает множество лидов

**Правила**:
- Каждый лид привязан к конкретной форме
- Владелец формы видит все лиды своих форм
- При удалении формы удаляются все её лиды
- Счетчик лидов обновляется автоматически

### Форма и база знаний

**Связь**: Одна форма может иметь базу знаний

**Правила**:
- База знаний улучшает качество генерации для конкретной формы
- Файлы загружаются отдельно для каждой формы
- При удалении формы удаляются все файлы базы знаний

### Лид и пользователь

**Связь**: Лид косвенно связан с пользователем через форму

**Правила**:
- При проверке лимита лидов учитываются все лиды всех форм пользователя
- Владелец формы может управлять лидами своих форм

### Системные настройки и генерация

**Связь**: Системные настройки влияют на все формы

**Правила**:
- Глобальные промпты применяются ко всем формам
- Индивидуальные промпты форм дополняют глобальные
- Только администратор может изменять системные настройки

---

## Особые случаи и правила

### Тестовый режим

**Email**: `hello@vasilkov.digital`

**Особенности**:
- Не увеличивает счетчик лидов формы
- Может использовать форму неограниченное количество раз
- Предыдущие записи с этим email удаляются перед созданием новой
- Используется для тестирования без влияния на статистику

### Тестирование формы владельцем

**Особенности**:
- Владелец может тестировать свою форму неограниченное количество раз
- Не увеличивает счетчик лидов формы
- Предыдущие записи удаляются перед созданием новой
- Проверяется дневной лимит тестирований (50 раз в день по умолчанию)

**Цель**: Позволить владельцу проверить работу формы без влияния на статистику лидов.

### Счетчик лидов

**Как работает**:
- Увеличивается автоматически при создании реального лида
- Не увеличивается для тестового email
- Не увеличивается для владельца формы (при тестировании)
- Уменьшается при удалении лида
- Обновляется атомарно (без ошибок при одновременных запросах)

**Важно**: Счетчик показывает только реальные лиды от респондентов.

### Дневной лимит тестирований

**Как работает**:
- Считается количество тестирований формы владельцем за день
- Сбрасывается автоматически каждый день в полночь
- Не влияет на обычных респондентов
- Администратор имеет неограниченный лимит

**Цель**: Предотвращение злоупотреблений и контроль использования ресурсов.

### База знаний

**Особенности**:
- Поддерживает текстовые файлы и изображения
- Изображения анализируются AI вместе с текстом
- HEIC изображения автоматически конвертируются в JPEG
- Все файлы загружаются полностью (без ограничений на размер контекста)

**Использование**: AI использует всю информацию из базы знаний для создания более точных и релевантных ответов.

### Генерация изображений

**Особенности**:
- Промпт для изображения создается автоматически через AI на основе всего контекста
- Если респондент загрузил изображение, оно редактируется
- Если нет, создается новое изображение
- Размер: 1024x1024 пикселей
- Изображения сохраняются в системе для постоянного доступа

### Безопасность данных

**Правила**:
- Каждый пользователь видит только свои данные
- Администратор имеет доступ ко всем данным
- Формы защищены от несанкционированного доступа
- Лиды доступны только владельцу формы

---

## Дефолтные значения

### Новый пользователь

- **Количество форм**: 2
- **Количество лидов**: 20 (суммарно)
- **Право на публикацию**: Разрешено
- **Хранилище**: 50 МБ
- **Тестирование в день**: 50 раз
- **Язык интерфейса**: Английский
- **Тема интерфейса**: Системная (следует настройкам браузера)

### Новая форма

- **Лимит лидов**: 20
- **Статус**: Неактивна (требуется активация)
- **Уведомления владельцу**: Включены
- **Email респонденту**: Включен
- **Тема формы**: Светлая
- **Язык сообщений**: Русский
- **Формат результата**: Текст
- **База знаний**: Выключена

---

## Сообщения об ошибках

### Ошибки создания формы

- **"Публикация форм отключена для вашего аккаунта"** — Администратор отключил возможность публикации форм. Нужно связаться с администратором.
- **"Достигнут лимит форм (X/Y)"** — Пользователь создал максимальное количество форм. Нужно удалить форму или связаться с администратором для увеличения лимита.

### Ошибки создания лида

- **"Достигнут лимит лидов для аккаунта (X/Y)"** — Владелец формы исчерпал лимит лидов. Нужно связаться с администратором для увеличения лимита.
- **"Достигнут дневной лимит тестирования (X/Y)"** — Владелец формы превысил дневной лимит тестирований. Лимит обновится завтра.
- **"Вы достигли лимита использований формы (5 раз)"** — Респондент использовал форму максимальное количество раз. Нужно зарегистрироваться для создания своих форм.

### Ошибки загрузки файлов

- **"Достигнут лимит файлов (10)"** — На форму уже загружено максимальное количество файлов. Нужно удалить ненужные файлы.
- **"Файл слишком большой. Максимальный размер: X МБ"** — Файл превышает допустимый размер. Нужно использовать файл меньшего размера.
- **"Превышен лимит хранилища (X/Y МБ)"** — Пользователь исчерпал лимит хранилища. Нужно удалить ненужные файлы или связаться с администратором.
- **"Неподдерживаемый тип файла"** — Файл имеет неподдерживаемый формат. Нужно использовать поддерживаемые форматы.

### Ошибки генерации

- **"Модель для генерации [текста/изображений] не настроена"** — Администратор не настроил AI-модель. Нужно связаться с администратором.
- **"Промпт для [текста/изображений] не настроен"** — Не настроен промпт для генерации. Нужно настроить промпт в системных настройках или для формы.
- **"Некорректная ссылка"** — Указанная ссылка неверна. Нужно проверить формат ссылки.
- **"Не удалось получить контент по ссылке"** — Система не смогла загрузить контент со страницы. Возможно, сайт недоступен или блокирует доступ.

---

*Документ обновлен: 30 января 2026*
